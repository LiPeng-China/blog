<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <link rel="icon" href="/blog/image/logo.svg"><title>九歌·太一博客</title><meta name="description" content="">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blog/assets/style-79715c17.css" as="style"><link rel="stylesheet" href="/blog/assets/style-79715c17.css">
    <link rel="modulepreload" href="/blog/assets/app-de24951d.js"><link rel="modulepreload" href="/blog/assets/framework-bf6cbb95.js"><link rel="modulepreload" href="/blog/assets/RabbitMQ.html-265a1ce4.js"><link rel="modulepreload" href="/blog/assets/RabbitMQ.html-28d81cce.js"><link rel="prefetch" href="/blog/assets/index.html-0ada5b9d.js" as="script"><link rel="prefetch" href="/blog/assets/1Panel.html-b3ebc885.js" as="script"><link rel="prefetch" href="/blog/assets/Docker.html-0673e7bc.js" as="script"><link rel="prefetch" href="/blog/assets/Environment.html-d2366ae3.js" as="script"><link rel="prefetch" href="/blog/assets/Linux命令.html-2975a0cf.js" as="script"><link rel="prefetch" href="/blog/assets/Sdkman.html-872885e4.js" as="script"><link rel="prefetch" href="/blog/assets/WSL.html-f68af3e1.js" as="script"><link rel="prefetch" href="/blog/assets/Git.html-9fb40536.js" as="script"><link rel="prefetch" href="/blog/assets/Latex.html-61945f37.js" as="script"><link rel="prefetch" href="/blog/assets/Maven.html-5091ee66.js" as="script"><link rel="prefetch" href="/blog/assets/PyTorch.html-507881d7.js" as="script"><link rel="prefetch" href="/blog/assets/Rust.html-f9e43d4c.js" as="script"><link rel="prefetch" href="/blog/assets/Docker.html-f3200953.js" as="script"><link rel="prefetch" href="/blog/assets/Git.html-191a03fc.js" as="script"><link rel="prefetch" href="/blog/assets/JDBC.html-1c16edf8.js" as="script"><link rel="prefetch" href="/blog/assets/JavaSE.html-4266d762.js" as="script"><link rel="prefetch" href="/blog/assets/JavaWeb.html-2bd2775c.js" as="script"><link rel="prefetch" href="/blog/assets/LaTex.html-e3ee6136.js" as="script"><link rel="prefetch" href="/blog/assets/Linux.html-016a9a4d.js" as="script"><link rel="prefetch" href="/blog/assets/Maven.html-f9087f1b.js" as="script"><link rel="prefetch" href="/blog/assets/MongoDB.html-81932121.js" as="script"><link rel="prefetch" href="/blog/assets/MyBatis.html-9fe40cd2.js" as="script"><link rel="prefetch" href="/blog/assets/MyBatisPlus.html-d19608c9.js" as="script"><link rel="prefetch" href="/blog/assets/MySQL.html-ab78a487.js" as="script"><link rel="prefetch" href="/blog/assets/Nginx.html-b80ed554.js" as="script"><link rel="prefetch" href="/blog/assets/Redis.html-f4d0da13.js" as="script"><link rel="prefetch" href="/blog/assets/Spring.html-f2624e5a.js" as="script"><link rel="prefetch" href="/blog/assets/SpringBoot.html-746bb138.js" as="script"><link rel="prefetch" href="/blog/assets/SpringCloud.html-dfeb2cd5.js" as="script"><link rel="prefetch" href="/blog/assets/SpringMVC.html-1eeba846.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.html-21c2bd9e.js" as="script"><link rel="prefetch" href="/blog/assets/408基础.html-3cb737c7.js" as="script"><link rel="prefetch" href="/blog/assets/Java.html-b318970d.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-f04ced3e.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fed4dd19.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-388ceb0e.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-6f8855af.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-b25e7a0a.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0da927e8.js" as="script"><link rel="prefetch" href="/blog/assets/1Panel.html-e513be9e.js" as="script"><link rel="prefetch" href="/blog/assets/Docker.html-dce18cd4.js" as="script"><link rel="prefetch" href="/blog/assets/Environment.html-0c2925f4.js" as="script"><link rel="prefetch" href="/blog/assets/Linux命令.html-9b09c954.js" as="script"><link rel="prefetch" href="/blog/assets/Sdkman.html-41b617a3.js" as="script"><link rel="prefetch" href="/blog/assets/WSL.html-c133ab73.js" as="script"><link rel="prefetch" href="/blog/assets/Git.html-24db1c3b.js" as="script"><link rel="prefetch" href="/blog/assets/Latex.html-63b5dc36.js" as="script"><link rel="prefetch" href="/blog/assets/Maven.html-8199822c.js" as="script"><link rel="prefetch" href="/blog/assets/PyTorch.html-6d84a0b8.js" as="script"><link rel="prefetch" href="/blog/assets/Rust.html-60e22196.js" as="script"><link rel="prefetch" href="/blog/assets/Docker.html-ce5ed287.js" as="script"><link rel="prefetch" href="/blog/assets/Git.html-17f9e230.js" as="script"><link rel="prefetch" href="/blog/assets/JDBC.html-79f70cba.js" as="script"><link rel="prefetch" href="/blog/assets/JavaSE.html-4c46cfcc.js" as="script"><link rel="prefetch" href="/blog/assets/JavaWeb.html-b4ca7eb3.js" as="script"><link rel="prefetch" href="/blog/assets/LaTex.html-4b973a2b.js" as="script"><link rel="prefetch" href="/blog/assets/Linux.html-5c0a1dbf.js" as="script"><link rel="prefetch" href="/blog/assets/Maven.html-cd849516.js" as="script"><link rel="prefetch" href="/blog/assets/MongoDB.html-8a748e11.js" as="script"><link rel="prefetch" href="/blog/assets/MyBatis.html-7725fbfd.js" as="script"><link rel="prefetch" href="/blog/assets/MyBatisPlus.html-ca4d77bc.js" as="script"><link rel="prefetch" href="/blog/assets/MySQL.html-16b0e73d.js" as="script"><link rel="prefetch" href="/blog/assets/Nginx.html-d54da099.js" as="script"><link rel="prefetch" href="/blog/assets/Redis.html-2fdd9bbd.js" as="script"><link rel="prefetch" href="/blog/assets/Spring.html-705df6e1.js" as="script"><link rel="prefetch" href="/blog/assets/SpringBoot.html-23f4cc5b.js" as="script"><link rel="prefetch" href="/blog/assets/SpringCloud.html-cba40542.js" as="script"><link rel="prefetch" href="/blog/assets/SpringMVC.html-7bf70993.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.html-a7d3bb94.js" as="script"><link rel="prefetch" href="/blog/assets/408基础.html-157d79d7.js" as="script"><link rel="prefetch" href="/blog/assets/Java.html-8dbd457b.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-7375e894.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-04bbd54c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-c7d9e0ef.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-41520081.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-00e749ce.js" as="script"><link rel="prefetch" href="/blog/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/blog/assets/index-b03bef79.js" as="script"><link rel="prefetch" href="/blog/assets/flowchart-8b576787.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-b6196a59.js" as="script"><link rel="prefetch" href="/blog/assets/photoswipe.esm-36cd6c3c.js" as="script"><link rel="prefetch" href="/blog/assets/SearchResult-37304c2b.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/blog/" class="brand"><img class="logo" src="/blog/image/logo.svg" alt="九歌·太一博客"><!----><span class="site-name hide-in-pad">九歌·太一博客</span></a><!--]--><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!--[--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" aria-label="首页"><span class="font-icon icon fa-fw fa-sm fas fa-house" style=""></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/%E7%AC%94%E8%AE%B0/" class="nav-link active" aria-label="笔记"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/%E9%9D%A2%E8%AF%95/" class="nav-link" aria-label="面试"><span class="font-icon icon fa-fw fa-sm fas fa-user" style=""></span>面试<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/%E5%B7%A5%E5%85%B7/" class="nav-link" aria-label="工具"><span class="font-icon icon fa-fw fa-sm fas fa-gear" style=""></span>工具<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/%E5%BC%80%E5%8F%91/" class="nav-link" aria-label="开发"><span class="font-icon icon fa-fw fa-sm fas fa-code" style=""></span>开发<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><img class="icon" src="/blog/image/java.svg" no-view style=""><span class="title">Java</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><img class="icon" src="/blog/image/spring.svg" no-view style=""><span class="title">Spring</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-database" style=""></span><span class="title">数据库</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><img class="icon" src="/blog/image/markdown.svg" no-view style=""><span class="title">Markdown</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><img class="icon" src="/blog/image/orm.svg" no-view style=""><span class="title">ORM</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><img class="icon" src="/blog/image/gears.svg" no-view style=""><span class="title">中间件</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/blog/%E7%AC%94%E8%AE%B0/Nginx.html" class="nav-link sidebar-link sidebar-page" aria-label="Nginx"><!---->Nginx<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#一、mq-介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="一、MQ 介绍"><!---->一、MQ 介绍<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、mq-基本概念" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、MQ 基本概念"><!---->1、MQ 基本概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、优缺点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、优缺点"><!---->2、优缺点<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、常见的-mq" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、常见的 MQ"><!---->3、常见的 MQ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、rabbitmq-概述" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、RabbitMQ 概述"><!---->4、RabbitMQ 概述<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、rabbitmq-名词介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5、RabbitMQ 名词介绍"><!---->5、RabbitMQ 名词介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_6、rabbitmq-工作模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6、RabbitMQ 工作模式"><!---->6、RabbitMQ 工作模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_7、rabbitmq-安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7、RabbitMQ 安装"><!---->7、RabbitMQ 安装<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#二、rabbitmq-快速入门" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="二、RabbitMQ 快速入门"><!---->二、RabbitMQ 快速入门<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#三、rabbitmq-工作模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="三、RabbitMQ 工作模式"><!---->三、RabbitMQ 工作模式<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、工作队列-work-queues" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、工作队列 Work queues"><!---->1、工作队列 Work queues<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、订阅模式-pub-sub" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、订阅模式 Pub/Sub"><!---->2、订阅模式 Pub/Sub<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、路由模式-routing" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、路由模式 Routing"><!---->3、路由模式 Routing<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、通配符模式-topics" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、通配符模式 Topics"><!---->4、通配符模式 Topics<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、工作模式总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5、工作模式总结"><!---->5、工作模式总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#四、springboot-整合-rabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="四、SpringBoot 整合 RabbitMQ"><!---->四、SpringBoot 整合 RabbitMQ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、添加相关依赖" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、添加相关依赖"><!---->1、添加相关依赖<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、简单模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、简单模式"><!---->2、简单模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、topic-模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、Topic 模式"><!---->3、Topic 模式<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#五、确认机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="五、确认机制"><!---->五、确认机制<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、发布确认机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、发布确认机制"><!---->1、发布确认机制<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、回退机制与备份交换机" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、回退机制与备份交换机"><!---->2、回退机制与备份交换机<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、消费者确认机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、消费者确认机制"><!---->3、消费者确认机制<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#六、死信队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="六、死信队列"><!---->六、死信队列<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、死信队列概述" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、死信队列概述"><!---->1、死信队列概述<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、死信队列架构图" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、死信队列架构图"><!---->2、死信队列架构图<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、ttl" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、TTL"><!---->3、TTL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、死信队列实操" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、死信队列实操"><!---->4、死信队列实操<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5、总结"><!---->5、总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#七、延迟队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="七、延迟队列"><!---->七、延迟队列<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、延时队列概述" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、延时队列概述"><!---->1、延时队列概述<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、延时队列实现" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、延时队列实现"><!---->2、延时队列实现<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、延迟队列插件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、延迟队列插件"><!---->3、延迟队列插件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、案例实现" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、案例实现"><!---->4、案例实现<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、延迟队列总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5、延迟队列总结"><!---->5、延迟队列总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#八、rabbitmq-实战场景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="八、RabbitMQ 实战场景"><!---->八、RabbitMQ 实战场景<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、日志与可视化监控查看" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、日志与可视化监控查看"><!---->1、日志与可视化监控查看<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、消息追踪" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、消息追踪"><!---->2、消息追踪<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、幂等性保证" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、幂等性保证"><!---->3、幂等性保证<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#九、rabbitmq-集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="九、RabbitMQ 集群"><!---->九、RabbitMQ 集群<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、目前存在的问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、目前存在的问题"><!---->1、目前存在的问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、搭建-rabbitmq-集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、搭建 RabbitMQ 集群"><!---->2、搭建 RabbitMQ 集群<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、rabbitmq-集群存在的问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3、RabbitMQ 集群存在的问题"><!---->3、RabbitMQ 集群存在的问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、rabbitmq-集群解决" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4、RabbitMQ 集群解决"><!---->4、RabbitMQ 集群解决<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><img class="icon" src="/blog/image/wrench.svg" no-view style=""><span class="title">工具</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!----></h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">九歌·太一</span></span><span property="author" content="九歌·太一"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-11-09T11:53:22.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 22 分钟</span><meta property="timeRequired" content="PT22M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#一、mq-介绍" class="router-link-active router-link-exact-active toc-link level2">一、MQ 介绍</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、mq-基本概念" class="router-link-active router-link-exact-active toc-link level3">1、MQ 基本概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、优缺点" class="router-link-active router-link-exact-active toc-link level3">2、优缺点</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、常见的-mq" class="router-link-active router-link-exact-active toc-link level3">3、常见的 MQ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、rabbitmq-概述" class="router-link-active router-link-exact-active toc-link level3">4、RabbitMQ 概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、rabbitmq-名词介绍" class="router-link-active router-link-exact-active toc-link level3">5、RabbitMQ 名词介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_6、rabbitmq-工作模式" class="router-link-active router-link-exact-active toc-link level3">6、RabbitMQ 工作模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_7、rabbitmq-安装" class="router-link-active router-link-exact-active toc-link level3">7、RabbitMQ 安装</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#二、rabbitmq-快速入门" class="router-link-active router-link-exact-active toc-link level2">二、RabbitMQ 快速入门</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#三、rabbitmq-工作模式" class="router-link-active router-link-exact-active toc-link level2">三、RabbitMQ 工作模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、工作队列-work-queues" class="router-link-active router-link-exact-active toc-link level3">1、工作队列 Work queues</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、订阅模式-pub-sub" class="router-link-active router-link-exact-active toc-link level3">2、订阅模式 Pub/Sub</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、路由模式-routing" class="router-link-active router-link-exact-active toc-link level3">3、路由模式 Routing</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、通配符模式-topics" class="router-link-active router-link-exact-active toc-link level3">4、通配符模式 Topics</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、工作模式总结" class="router-link-active router-link-exact-active toc-link level3">5、工作模式总结</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#四、springboot-整合-rabbitmq" class="router-link-active router-link-exact-active toc-link level2">四、SpringBoot 整合 RabbitMQ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、添加相关依赖" class="router-link-active router-link-exact-active toc-link level3">1、添加相关依赖</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、简单模式" class="router-link-active router-link-exact-active toc-link level3">2、简单模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、topic-模式" class="router-link-active router-link-exact-active toc-link level3">3、Topic 模式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#五、确认机制" class="router-link-active router-link-exact-active toc-link level2">五、确认机制</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、发布确认机制" class="router-link-active router-link-exact-active toc-link level3">1、发布确认机制</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、回退机制与备份交换机" class="router-link-active router-link-exact-active toc-link level3">2、回退机制与备份交换机</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、消费者确认机制" class="router-link-active router-link-exact-active toc-link level3">3、消费者确认机制</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#六、死信队列" class="router-link-active router-link-exact-active toc-link level2">六、死信队列</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、死信队列概述" class="router-link-active router-link-exact-active toc-link level3">1、死信队列概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、死信队列架构图" class="router-link-active router-link-exact-active toc-link level3">2、死信队列架构图</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、ttl" class="router-link-active router-link-exact-active toc-link level3">3、TTL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、死信队列实操" class="router-link-active router-link-exact-active toc-link level3">4、死信队列实操</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、总结" class="router-link-active router-link-exact-active toc-link level3">5、总结</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#七、延迟队列" class="router-link-active router-link-exact-active toc-link level2">七、延迟队列</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、延时队列概述" class="router-link-active router-link-exact-active toc-link level3">1、延时队列概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、延时队列实现" class="router-link-active router-link-exact-active toc-link level3">2、延时队列实现</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、延迟队列插件" class="router-link-active router-link-exact-active toc-link level3">3、延迟队列插件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、案例实现" class="router-link-active router-link-exact-active toc-link level3">4、案例实现</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_5、延迟队列总结" class="router-link-active router-link-exact-active toc-link level3">5、延迟队列总结</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#八、rabbitmq-实战场景" class="router-link-active router-link-exact-active toc-link level2">八、RabbitMQ 实战场景</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、日志与可视化监控查看" class="router-link-active router-link-exact-active toc-link level3">1、日志与可视化监控查看</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、消息追踪" class="router-link-active router-link-exact-active toc-link level3">2、消息追踪</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、幂等性保证" class="router-link-active router-link-exact-active toc-link level3">3、幂等性保证</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#九、rabbitmq-集群" class="router-link-active router-link-exact-active toc-link level2">九、RabbitMQ 集群</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_1、目前存在的问题" class="router-link-active router-link-exact-active toc-link level3">1、目前存在的问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_2、搭建-rabbitmq-集群" class="router-link-active router-link-exact-active toc-link level3">2、搭建 RabbitMQ 集群</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_3、rabbitmq-集群存在的问题" class="router-link-active router-link-exact-active toc-link level3">3、RabbitMQ 集群存在的问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/%E7%AC%94%E8%AE%B0/RabbitMQ.html#_4、rabbitmq-集群解决" class="router-link-active router-link-exact-active toc-link level3">4、RabbitMQ 集群解决</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="一、mq-介绍" tabindex="-1"><a class="header-anchor" href="#一、mq-介绍" aria-hidden="true">#</a> 一、MQ 介绍</h2><h3 id="_1、mq-基本概念" tabindex="-1"><a class="header-anchor" href="#_1、mq-基本概念" aria-hidden="true">#</a> 1、MQ 基本概念</h3><blockquote><p>概述：MQ（Message Queue）：消息队列，FIFO 数据结构</p><p>应用：流量削峰、应用解耦、异步处理等，实现高性能、高可用，可伸缩和最终一致性架构</p></blockquote><p>总结：</p><ul><li>MQ：消息队列，用于消息传递的中间件</li><li>生产者：消息发送方</li><li>消费者：消息接收方</li></ul><h3 id="_2、优缺点" tabindex="-1"><a class="header-anchor" href="#_2、优缺点" aria-hidden="true">#</a> 2、优缺点</h3><p>MQ 优点：</p><ul><li>流量削峰</li><li>应用解耦</li><li>异步处理</li></ul><p>MQ 缺点：</p><ul><li>提高了系统的复杂度，降低了系统的稳定性和可用性 <ul><li>引入第三方技术，增加了宕机的风险</li><li>如何保证系统的高可用？</li></ul></li><li>带来了数据一致性问题 <ul><li>各系统之间的调用增加了不确定性，如何保证最终一致性？</li><li>怎么处理消息丢失情况？</li></ul></li></ul><h3 id="_3、常见的-mq" tabindex="-1"><a class="header-anchor" href="#_3、常见的-mq" aria-hidden="true">#</a> 3、常见的 MQ</h3><figure><img src="/blog/assets/常见的MQ-b15563eb.png" alt="常见的MQ" tabindex="0" loading="lazy"><figcaption>常见的MQ</figcaption></figure><p><strong>AMQP</strong>，即 Advanced Message Queuing Protocol (高级消息队列协议) ，是一个网络协议，是应用层协议的一个开放标准，为面向消息的中间件设计。2006年，AMQP 规范发布。</p><h3 id="_4、rabbitmq-概述" tabindex="-1"><a class="header-anchor" href="#_4、rabbitmq-概述" aria-hidden="true">#</a> 4、RabbitMQ 概述</h3><blockquote><p>RabbitMQ 是实现了高级消息队列协议的开源消息代理软件</p></blockquote><figure><img src="/blog/assets/RabbitMQ架构图-e057f34b.png" alt="RabbitMQ架构图" tabindex="0" loading="lazy"><figcaption>RabbitMQ架构图</figcaption></figure><h3 id="_5、rabbitmq-名词介绍" tabindex="-1"><a class="header-anchor" href="#_5、rabbitmq-名词介绍" aria-hidden="true">#</a> 5、RabbitMQ 名词介绍</h3><ul><li>Producer：生产者，发送消息的程序</li><li>Consumer：消费者，接收消息的程序</li><li>Broker：接收和分发消息的应用，RabbitMQ Server 就是 Message Broker</li><li>Connection：生产者、消费者、Broker 之间的 TCP 连接</li><li>Channel：通信连接信道，降低 TCP 连接开销</li><li>Virtual host：虚拟主机</li><li>Exchange：交换机，message 到达 Broker 先存放到交换机</li><li>Queue：队列，消费者从这里获取消息</li><li>Binding：交换机与队列之间的虚拟链接，用于消息分发</li></ul><h3 id="_6、rabbitmq-工作模式" tabindex="-1"><a class="header-anchor" href="#_6、rabbitmq-工作模式" aria-hidden="true">#</a> 6、RabbitMQ 工作模式</h3><figure><img src="/blog/assets/RabbitMQ工作模式-5821b225.png" alt="RabbitMQ工作模式" tabindex="0" loading="lazy"><figcaption>RabbitMQ工作模式</figcaption></figure><h3 id="_7、rabbitmq-安装" tabindex="-1"><a class="header-anchor" href="#_7、rabbitmq-安装" aria-hidden="true">#</a> 7、RabbitMQ 安装</h3><p>1、安装 socat</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> socat <span class="token parameter variable">-y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2、安装 erlang 环境</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> erlang-23.3.4.5-1.el7.x86_64.rpm 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>3、安装 RabbitMQ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> rabbitmq-server-3.8.34-1.suse.noarch.rpm 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>4、开启管理界面</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>5、启动 RabbitMQ 服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl start rabbitmq-server.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>7、防火墙开放端口</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">15672</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>8、添加新用户</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> rabbitmqctl add_user taiyi <span class="token number">123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>9、设置用户角色</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> rabbitmqctl set_user_tags taiyi administrator
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>10、设置权限</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code> <span class="token function">sudo</span> rabbitmqctl set_permissions <span class="token parameter variable">-p</span> <span class="token string">&quot;/&quot;</span> taiyi <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>11、查看用户和角色</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> rabbitmqctl list_users
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>12、本机访问</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ipv4:15672
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>13、停止服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitctl stop_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>14、启动服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitctl start_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>15、重置服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitctl reset
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="二、rabbitmq-快速入门" tabindex="-1"><a class="header-anchor" href="#二、rabbitmq-快速入门" aria-hidden="true">#</a> 二、RabbitMQ 快速入门</h2><figure><img src="/blog/assets/简单模式-5ff351ee.png" alt="简单模式" tabindex="0" loading="lazy"><figcaption>简单模式</figcaption></figure><p>1、添加依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、创建生产者</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 建立连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置主机 IP、 用户、密码</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.81.128&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;taiyi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通道 和 队列 的连接</span>
            <span class="token comment">/*
            queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments) throws IOException;
            参数说明：
                queue：队列名称
                durable：是否持久化
                exclusive：是否独占，是否只有一个消费者监听一个队列
                autoDelete：是否自动删除，如果没有消费者，自动删除队列
                arguments：参数
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 待发送的消息</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;Hello World! RabbitMQ!&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过最基础的发布</span>
            <span class="token comment">/*
             basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body) throws IOException;
             参数说明：
                exchange：指定交换机，如果使用默认模式，就是用“”
                routingKey：路由名称
                props：配置信息
                body：发送的消息（要求字节数组）
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送成功后打印</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; [x] Sent &#39;&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、消费者</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 建立连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置主机 IP、 用户、密码</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.81.128&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;taiyi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 建立连接 获取通道</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)
        参数说明：
            queue：队列名称（消费的队列名称）
            durable：是否持久化
            exclusive：是否独占，是否只有一个消费者监听一个队列
            autoDelete：是否自动删除，如果没有消费者，自动删除队列
            arguments：参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; [*] Waiting for messages. To exit press CTRL+C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        basicConsume(String queue, boolean autoAck, DeliverCallback deliverCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)
         */</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; [x] Received &#39;&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        basicConsume(String queue, boolean autoAck, DeliverCallback deliverCallback, CancelCallback cancelCallback)
        参数说明：
            queue：队列名称
            autoAck：是否自动确认
            deliverCallback：消费回调对消
            cancelCallback：取消回调
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="三、rabbitmq-工作模式" tabindex="-1"><a class="header-anchor" href="#三、rabbitmq-工作模式" aria-hidden="true">#</a> 三、RabbitMQ 工作模式</h2><h3 id="_1、工作队列-work-queues" tabindex="-1"><a class="header-anchor" href="#_1、工作队列-work-queues" aria-hidden="true">#</a> 1、工作队列 Work queues</h3><h4 id="_1-2-概述" tabindex="-1"><a class="header-anchor" href="#_1-2-概述" aria-hidden="true">#</a> 1.2 概述</h4><ul><li><p>工作队列与简单模式相比，多了一些消费端：多个消费端共同消费同一个队列中的消息</p><figure><img src="/blog/assets/工作队列模式-57331a08.png" alt="工作队列模式" tabindex="0" loading="lazy"><figcaption>工作队列模式</figcaption></figure></li><li><p>使用场景：对于消息生产速度大于消费速度的场景，可以增加消费者减少消费者压力</p></li></ul><h4 id="_1-2-总结" tabindex="-1"><a class="header-anchor" href="#_1-2-总结" aria-hidden="true">#</a> 1.2 总结</h4><ul><li>分发机制：轮询分发机制</li><li>应用场景：同一条消息，在多个消费者之间只能有一个消息，应用于只需要单节点消费的场景（发送验证码，发送生日提醒）</li></ul><h3 id="_2、订阅模式-pub-sub" tabindex="-1"><a class="header-anchor" href="#_2、订阅模式-pub-sub" aria-hidden="true">#</a> 2、订阅模式 Pub/Sub</h3><h4 id="_2-1-概述" tabindex="-1"><a class="header-anchor" href="#_2-1-概述" aria-hidden="true">#</a> 2.1 概述</h4><ul><li><p>在订阅模型中，多了一个 Exchange 角色</p></li><li><p>Exchange：交换机（X），接收生产者放发送的消息，处理投递消息，例如递交给某个特别队列，递交给所有队列、或是将消息丢弃</p></li><li><p>交换机类型：</p><ul><li><p>Fanout：广播，将消息交给所有绑定到交换机的队列</p></li><li><p>Direct：定向，把消息交给符合指定 routing key 的队列</p></li><li><p>Topic：通配符，把消息交给符合 routing pattern（路由模式）的队列</p><figure><img src="/blog/assets/发布订阅模式-53f59bf3.png" alt="发布订阅模式" tabindex="0" loading="lazy"><figcaption>发布订阅模式</figcaption></figure></li></ul></li><li><p>注意：交换机并不具备存储消息的能力，如果没有队列绑定，则消息会丢失</p></li></ul><h4 id="_2-2-总结" tabindex="-1"><a class="header-anchor" href="#_2-2-总结" aria-hidden="true">#</a> 2.2 总结：</h4><ul><li>交换机与队列进行绑定，绑定之后；一个消息可以被多个队列都接收到</li><li>PubSub 模式与 WorkQueues 模式的区别（面试）： <ul><li>WorkQueues 模式不用定义交换机，而 PubSub 模式需要定义交换机</li><li>PubSub 模式的生产方是面向交换机发送消息，WorkQueue 模式的生产方是面向队列发送消息</li><li>PubSub 模式需要手动设置队列和交换机的绑定</li></ul></li></ul><h3 id="_3、路由模式-routing" tabindex="-1"><a class="header-anchor" href="#_3、路由模式-routing" aria-hidden="true">#</a> 3、路由模式 Routing</h3><h4 id="_3-1-概述" tabindex="-1"><a class="header-anchor" href="#_3-1-概述" aria-hidden="true">#</a> 3.1 概述</h4><ul><li><p>RoutingKey 编写规则：有一个或多个单词组成，多个单词用 <code>.</code> 分割，比如 order.save</p></li><li><p>路由模型：</p><ul><li><p>队列与交换机的绑定需要指定路由 RoutingKey</p></li><li><p>生产者在向 Exchange 发送消息时，也必须指定消息的 RoutingKey</p></li><li><p>交换机分发的规则根据 RoutingKey 来分发给相应的队列</p><figure><img src="/blog/assets/路由模式-9e89934e.png" alt="路由模式" tabindex="0" loading="lazy"><figcaption>路由模式</figcaption></figure></li></ul></li></ul><h4 id="_3-2-总结" tabindex="-1"><a class="header-anchor" href="#_3-2-总结" aria-hidden="true">#</a> 3.2 总结</h4><ul><li>生产者发送消息时要指定 RoutingKey</li><li>队列与交换机绑定也需要指定 RoutingKey</li></ul><h3 id="_4、通配符模式-topics" tabindex="-1"><a class="header-anchor" href="#_4、通配符模式-topics" aria-hidden="true">#</a> 4、通配符模式 Topics</h3><h4 id="_4-1-概述" tabindex="-1"><a class="header-anchor" href="#_4-1-概述" aria-hidden="true">#</a> 4.1 概述</h4><ul><li><p>Topics 模式可以通过通配符配置 RoutingKey，会更加灵活</p></li><li><p>通配符规则：</p><ul><li><p><code>#</code>：匹配一个或多个词。比如 order.# 可以匹配 order.save，order.product.update ...</p></li><li><p><code>*</code>：匹配一个单词。比如 order.* 可以匹配 order.save</p><figure><img src="/blog/assets/通配符模式-3b787df4.png" alt="通配符模式" tabindex="0" loading="lazy"><figcaption>通配符模式</figcaption></figure></li></ul></li></ul><h4 id="_4-2-总结" tabindex="-1"><a class="header-anchor" href="#_4-2-总结" aria-hidden="true">#</a> 4.2 总结</h4><ul><li>Topic 模式可以实现 Pub/Sub 模式和 Routing 模式的功能</li><li>Topic 模式在配置 RoutingKey 的时候可以使用通配符，更加灵活好用</li></ul><h3 id="_5、工作模式总结" tabindex="-1"><a class="header-anchor" href="#_5、工作模式总结" aria-hidden="true">#</a> 5、工作模式总结</h3><ol><li>简单模式 HelloWorld：一个生产者、一个消费者，不需要设置交换机，使用默认的交换机</li><li>工作队列模式 Work Queue ：一个生产者、多个消费者(排它关系) ，不需要设置交换机，使用默认的交换机</li><li>发布订阅模式 Publish/Subscribe：设置类型为 fanout 的交换机，同时让交换机和队列绑定，交换机会将消息发送到绑定的队列</li><li>路由模式 Routing：设置 direct 交换机，并且指定 routing key，交换机根据 routing key 将消息发送到对应的队列</li><li>通配符模式 Topic：设置类型为 topic 的交换机，交换机和队列进行绑定，并且指定通配符方式的 routing key，交换机根据通配符分发消息到队列</li></ol><h2 id="四、springboot-整合-rabbitmq" tabindex="-1"><a class="header-anchor" href="#四、springboot-整合-rabbitmq" aria-hidden="true">#</a> 四、SpringBoot 整合 RabbitMQ</h2><h3 id="_1、添加相关依赖" tabindex="-1"><a class="header-anchor" href="#_1、添加相关依赖" aria-hidden="true">#</a> 1、添加相关依赖</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2、简单模式" tabindex="-1"><a class="header-anchor" href="#_2、简单模式" aria-hidden="true">#</a> 2、简单模式</h3><p>配置队列</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 创建队列
     *
     * <span class="token keyword">@return</span> 队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">helloQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;springboot-queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">Queue</span> helloQueue<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send2Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>helloQueue<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;hello spring boot rabbitmq&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接收消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageReceive</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;springboot-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收消息：&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、topic-模式" tabindex="-1"><a class="header-anchor" href="#_3、topic-模式" aria-hidden="true">#</a> 3、Topic 模式</h3><p>配置交换机和队列</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 创建topic队列
     *
     * <span class="token keyword">@return</span> 队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">topicQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;springboot-topic-queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 创建topic交换机
     *
     * <span class="token keyword">@return</span> 交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token string">&quot;springboot-topic-exchange&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">topicBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span>
                <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">topicQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">// 绑定队列</span>
                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 绑定交换机</span>
                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;taiyi.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 指定路由</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">Exchange</span> topicExchange<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send2Topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>topicExchange<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;taiyi.order&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello topic rabbitmq&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接收消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageReceive</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;springboot-topic-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收消息：&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="五、确认机制" tabindex="-1"><a class="header-anchor" href="#五、确认机制" aria-hidden="true">#</a> 五、确认机制</h2><h3 id="_1、发布确认机制" tabindex="-1"><a class="header-anchor" href="#_1、发布确认机制" aria-hidden="true">#</a> 1、发布确认机制</h3><h4 id="_1-1-生产者投递丢失问题" tabindex="-1"><a class="header-anchor" href="#_1-1-生产者投递丢失问题" aria-hidden="true">#</a> 1.1 生产者投递丢失问题</h4><p>如果生产者 P 投递消息到交换机 X 的过程中，出现了网络延迟，导致消息丢失，怎么保证消息安全？</p><figure><img src="/blog/assets/生产者投递丢失问题-0a1ce8fe.png" alt="生产者投递丢失问题" tabindex="0" loading="lazy"><figcaption>生产者投递丢失问题</figcaption></figure><h4 id="_1-2-通过发布确认机制解决" tabindex="-1"><a class="header-anchor" href="#_1-2-通过发布确认机制解决" aria-hidden="true">#</a> 1.2 通过发布确认机制解决</h4><p>生产者 P 投递消息到交换机 X 的过程中，交换机会给生产者 P 一个 ACK 确认回调，生产者可以根据收到的 ACK 值知道是否投递成功。</p><figure><img src="/blog/assets/发布确认机制-bff9e6a3.png" alt="发布确认机制" tabindex="0" loading="lazy"><figcaption>发布确认机制</figcaption></figure><h4 id="_1-3-实操" tabindex="-1"><a class="header-anchor" href="#_1-3-实操" aria-hidden="true">#</a> 1.3 实操</h4><p>application.yml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.81.128
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> taiyi
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated  <span class="token comment"># 确认消息发送到交换机</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RabbitMqConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm-queue&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> <span class="token class-name">AckCallback</span> ackCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 新建交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">confirmExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 队列</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定交换机和队列</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">confirmBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">confirmExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AckCallback</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AckCallback</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> correlationData <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机已经收到消息 id：{}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机没有收到消息 id：{}, 原因是：{}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试验证</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">CorrelationData</span> correlationData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;confirm-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;你好&quot;</span><span class="token punctuation">,</span> correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2、回退机制与备份交换机" tabindex="-1"><a class="header-anchor" href="#_2、回退机制与备份交换机" aria-hidden="true">#</a> 2、回退机制与备份交换机</h3><h4 id="_2-1-交换机无法路由问题" tabindex="-1"><a class="header-anchor" href="#_2-1-交换机无法路由问题" aria-hidden="true">#</a> 2.1 交换机无法路由问题</h4><p>生产者 P 投递消息到交换机 X 的过程中，消息确定收到了，但是路由配置错误，或者没有绑定队列，此时如何保证消息的安全性？</p><figure><img src="/blog/assets/交换机无法路由问题-14771466.png" alt="交换机无法路由问题" tabindex="0" loading="lazy"><figcaption>交换机无法路由问题</figcaption></figure><h4 id="_2-2-回退机制让生产者自行处理" tabindex="-1"><a class="header-anchor" href="#_2-2-回退机制让生产者自行处理" aria-hidden="true">#</a> 2.2 回退机制让生产者自行处理</h4><p>可以通过回退机制，通知消费者此条消息无法处理，让消费者自行处理消息</p><figure><img src="/blog/assets/回退机制-24bc96e4.png" alt="回退机制" tabindex="0" loading="lazy"><figcaption>回退机制</figcaption></figure><h4 id="_2-3-回退机制实操" tabindex="-1"><a class="header-anchor" href="#_2-3-回退机制实操" aria-hidden="true">#</a> 2.3 回退机制实操</h4><p>ReturnCallback</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReturnCallback</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnsCallback</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">ReturnedMessage</span> returnedMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} 消息返回，退回原因：{}， 退回码：{}&quot;</span><span class="token punctuation">,</span>
                returnedMessage<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                returnedMessage<span class="token punctuation">.</span><span class="token function">getReplyText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                returnedMessage<span class="token punctuation">.</span><span class="token function">getReplyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        处理方式：
            1、尝试重新调用
            2、落库处理，存入 MySQL 数据库中
        */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RabbitMqConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> <span class="token class-name">AckCallback</span> ackCallback<span class="token punctuation">,</span> <span class="token class-name">ReturnCallback</span> returnCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span>returnCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-备份交换机解决无法路由问题" tabindex="-1"><a class="header-anchor" href="#_2-4-备份交换机解决无法路由问题" aria-hidden="true">#</a> 2.4 备份交换机解决无法路由问题</h4><p>备份交换机设置 Fanout 类型，可以添加备份队列，还可以添加告警队列，还可以添加入库队列</p><figure><img src="/blog/assets/备份交换机-7a5e97c7.png" alt="备份交换机" tabindex="0" loading="lazy"><figcaption>备份交换机</figcaption></figure><p>注意：添加备份交换机之后，回退机制将不会触发</p><h4 id="_2-5-备份交换机实操" tabindex="-1"><a class="header-anchor" href="#_2-5-备份交换机实操" aria-hidden="true">#</a> 2.5 备份交换机实操</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACK_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;back-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACK_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;back-queue&quot;</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> <span class="token class-name">AckCallback</span> ackCallback<span class="token punctuation">,</span> <span class="token class-name">ReturnCallback</span> returnCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 回退机制开启</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span>returnCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明确认交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;confirmExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">confirmExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span>
                <span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withArgument</span><span class="token punctuation">(</span><span class="token string">&quot;alternate-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">BACK_EXCHANGE_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明确认队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;confirmQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定确认队列和确认交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">confirmBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">confirmExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明备份交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;backExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">backExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token constant">BACK_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明备份队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;backQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">backQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BACK_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定备份交换机和备份队列</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">backBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">backQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">backExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、消费者确认机制" tabindex="-1"><a class="header-anchor" href="#_3、消费者确认机制" aria-hidden="true">#</a> 3、消费者确认机制</h3><h4 id="_3-1-消费者异常导致数据丢失" tabindex="-1"><a class="header-anchor" href="#_3-1-消费者异常导致数据丢失" aria-hidden="true">#</a> 3.1 消费者异常导致数据丢失</h4><p>如果消费者处理过程中发生异常，导致消息丢失怎么办？</p><figure><img src="/blog/assets/消费者异常导致数据丢失-a405f191.png" alt="消费者异常导致数据丢失" tabindex="0" loading="lazy"><figcaption>消费者异常导致数据丢失</figcaption></figure><h4 id="_3-2-消费者确认机制" tabindex="-1"><a class="header-anchor" href="#_3-2-消费者确认机制" aria-hidden="true">#</a> 3.2 消费者确认机制</h4><p>三种确认方式：</p><ol><li>自动确认：<code>ackonwledge=none</code></li><li>手动确认：<code>ackonwledge=manual</code>（主要研究）</li><li>根据异常情况确认：<code>ackonwledge=auto</code>（复杂，不去研究）</li></ol><ul><li><p>手动确认图解：</p><figure><img src="/blog/assets/消费者确认机制-d3303384.png" alt="消费者确认机制" tabindex="0" loading="lazy"><figcaption>消费者确认机制</figcaption></figure></li><li><p>手动确认程序：</p><p>application.yml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.81.128
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> taiyi
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">retry</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual  <span class="token comment"># 手动 ack</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageReceive</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;back-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receive message:{}&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 开始处理业务</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// 业务处理结束</span>
            <span class="token comment">// 正常签收，参数：multiple</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRedelivered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 消息是否重复处理过</span>
                <span class="token comment">// 拒绝签收,丢弃；参数：requeue</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;message重复处理之后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 返回队列，重新发送；参数：multiple,requeue</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;message没有重复处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="六、死信队列" tabindex="-1"><a class="header-anchor" href="#六、死信队列" aria-hidden="true">#</a> 六、死信队列</h2><h3 id="_1、死信队列概述" tabindex="-1"><a class="header-anchor" href="#_1、死信队列概述" aria-hidden="true">#</a> 1、死信队列概述</h3><ul><li><strong>死信</strong>（Dead Letter）是 RabbitMQ 的一种消息机制，如果出现以下情况消息将变成死信： <ol><li>消息在队列的存活时间超过设置的生存时间（TTL）时间</li><li>消息队列的消息数量已经超过最大队列长度</li><li>消息被否定确认，使用basicNack或basicReject并且 requeue=false</li></ol></li><li><strong>死信队列</strong>（Dead Letter Queue）用来存放死信消息的队列</li><li><strong>死信交换机</strong>（Dead Letter Exchange）用来路由死信消息的交换机</li></ul><h3 id="_2、死信队列架构图" tabindex="-1"><a class="header-anchor" href="#_2、死信队列架构图" aria-hidden="true">#</a> 2、死信队列架构图</h3><figure><img src="/blog/assets/死信队列架构图-ebdc3829.png" alt="死信队列架构图" tabindex="0" loading="lazy"><figcaption>死信队列架构图</figcaption></figure><h3 id="_3、ttl" tabindex="-1"><a class="header-anchor" href="#_3、ttl" aria-hidden="true">#</a> 3、TTL</h3><ul><li><p>TTL 概述：用来控制消息或者队列的最大存活时间，单位是毫秒</p></li><li><p>设置 TTL 的两种方式：</p><ol><li>给消息设置 TTL</li><li>给队列设置 TTL</li></ol></li><li><p>注意：如果同时配置消息 TTL 和队列 TTL，那么较小的那个值将会被使用</p></li><li><p>区别（面试）：</p><ol><li><p>消息设置 TTL 的方式是在消费时做消息过期判断，如果是顶端的，到期直接移除</p><p>RabbitMQ 只会判断队列最前端的消息是否过期，如果过期，移除；如果没有过期，保留（哪怕第二条消息已经过期也不去管理）</p></li><li><p>队列设置过期是直接丢弃或者丢到死信队列（并不是使用轮训机制判断消息过期的，还是只判断队列头部的消息，因为最先过期的消息一定是最先进入队列的，也就处于队列的最开始）</p></li></ol></li></ul><h3 id="_4、死信队列实操" tabindex="-1"><a class="header-anchor" href="#_4、死信队列实操" aria-hidden="true">#</a> 4、死信队列实操</h3><ul><li><p>案例：</p><ol><li>达到最大长度进入死信队列</li><li>达到过期时间进入死信队列</li><li>拒收进入死信队列</li></ol></li><li><p>代码：</p><p>RabbitMqConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TEST_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;test-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TEST_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;test-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-test-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead_queue-queue&quot;</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> <span class="token class-name">AckCallback</span> ackCallback<span class="token punctuation">,</span> <span class="token class-name">ReturnCallback</span> returnCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 回退机制开启</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span>returnCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;testExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">testExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span>
                <span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">TEST_EXCHANGE_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;testQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">testQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// return QueueBuilder.durable(TEST_QUEUE_NAME).build(); // 普通队列</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定死信交换机</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 案例1：达到最大长度进入死信队列。限制队列最大长度</span>
        <span class="token comment">// map.put(&quot;x-max-length&quot;, 10);</span>
        <span class="token comment">// 案例2：达到过期时间进入死信队列。设置队列的消息TTL</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">TEST_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 过期队列</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定确认队列和确认交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">testBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">testQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">testExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明死信交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;deadExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明备份队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;deadQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定死信交换机和死信队列</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deadBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ApiTest</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;test-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;你好，死信机制&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>案例三部分接收代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageReceive</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;test-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 开始处理业务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;收到异常队列信息:{}&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;收到队列信息:{}&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 业务处理结束</span>
            <span class="token comment">// 正常签收，参数：multiple</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRedelivered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 消息是否重复处理过</span>
                <span class="token comment">// 拒绝签收,丢弃；参数：requeue</span>
                channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 返回队列，重新发送；参数：multiple,requeue</span>
                channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_5、总结" tabindex="-1"><a class="header-anchor" href="#_5、总结" aria-hidden="true">#</a> 5、总结</h3><ol><li>死信交换机和死信队列和普通交换机和普通队列没有区别</li><li>当消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列</li><li>消息成为死信的3中情况（面试）： <ol><li>消息在队列的存活时间超过了设置的 TTL</li><li>消息队列的消息数量超过了最大队列长度</li><li>消息被否定确认，使用 basicNack 或 basicReject 并且 requeue=false</li></ol></li></ol><h2 id="七、延迟队列" tabindex="-1"><a class="header-anchor" href="#七、延迟队列" aria-hidden="true">#</a> 七、延迟队列</h2><h3 id="_1、延时队列概述" tabindex="-1"><a class="header-anchor" href="#_1、延时队列概述" aria-hidden="true">#</a> 1、延时队列概述</h3><ul><li><p>延时队列：消息进入队列后，不会立即被消费，只有达到指定时间后，才会消费，最重要的特征就是延迟上</p></li><li><p>应用场景：</p><ol><li>12306 购票 30min 内不支付自动取消订单，回滚库存</li><li>会议设置，15min 前通知参会人员</li></ol></li><li><p>流程图示：</p><figure><img src="/blog/assets/延时队列流程-3dfaeac4.png" alt="延时队列流程" tabindex="0" loading="lazy"><figcaption>延时队列流程</figcaption></figure></li></ul><h3 id="_2、延时队列实现" tabindex="-1"><a class="header-anchor" href="#_2、延时队列实现" aria-hidden="true">#</a> 2、延时队列实现</h3><p>RabbitMQ 为提供延时队列功能，可以通过 TTL + 死信队列的方式设计出延时队列</p><figure><img src="/blog/assets/RabbitMQ实现延时队列-273648ec.png" alt="RabbitMQ实现延时队列" tabindex="0" loading="lazy"><figcaption>RabbitMQ实现延时队列</figcaption></figure><p>代码实现：</p><p>RabbitMqConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delay-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delay-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-delay-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-delay-queue&quot;</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> <span class="token class-name">AckCallback</span> ackCallback<span class="token punctuation">,</span> <span class="token class-name">ReturnCallback</span> returnCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 回退机制开启</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span>returnCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;testExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">testExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span>
                <span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;testQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">testQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定死信交换机</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 过期队列</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定确认队列和确认交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">testBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">testQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">testExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明死信交换机</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;deadExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明备份队列</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;deadQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定死信交换机和死信队列</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deadBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessagePostProcessor</span> processor <span class="token operator">=</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageProperties<span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token string">&quot;5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;delay-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;你好，延迟队列&quot;</span><span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码实现存在的问题：</p><ul><li>发现消息不能按最近过期时间消费</li><li>原因：设置了消息 TTL，延迟队列只判断队列开头信息是否过期，只要它不过期，后续信息就不会判断过期时间（哪怕它们已经过期，也不会进入延迟队列中等待被消费）</li></ul><h3 id="_3、延迟队列插件" tabindex="-1"><a class="header-anchor" href="#_3、延迟队列插件" aria-hidden="true">#</a> 3、延迟队列插件</h3><ul><li><p>启用延迟插件服务：</p><ol><li><p>插件安装位置</p><p><code>/usr/lib/rabbitmq/lib/rabbitmq_server-3.8.34/plugins</code></p></li><li><p>启用插件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_delayed_message_exchange
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>重启服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl start_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol></li><li><p>代码实现：</p><p>RabbitMqPluginConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableRabbit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqPluginConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;plugin-delay-exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;plugin-delay-queue&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> <span class="token class-name">AckCallback</span> ackCallback<span class="token punctuation">,</span> <span class="token class-name">ReturnCallback</span> returnCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 回退机制开启</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span>returnCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomExchange</span> <span class="token function">pluginDelayExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义交换机的类型</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-delayed-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomExchange</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;x-delayed-message&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明队列</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">pluginDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定队列和交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">testBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">pluginDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">pluginDelayExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;ack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPluginDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessagePostProcessor</span> processor <span class="token operator">=</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageProperties<span class="token punctuation">.</span><span class="token function">setDelay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;plugin-delay-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5s 的延迟消息&quot;</span><span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_4、案例实现" tabindex="-1"><a class="header-anchor" href="#_4、案例实现" aria-hidden="true">#</a> 4、案例实现</h3><ul><li><p>案例说明：12306 实现 30min 内未付款自动取消订单回滚库存</p></li><li><p>代码实现</p><ol><li>创建订单系统：发送订单进延迟队列</li><li>创建库存系统：接受延迟队列中的数据做业务处理，如果已经支付不做任何操作，如果没有支付则取消订单回滚库存</li></ol></li><li><p>代码实现</p><p>消息发送方</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CorrelationData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessagePostProcessor</span> processor <span class="token operator">=</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageProperties<span class="token punctuation">.</span><span class="token function">setDelay</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;plugin-delay-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ack&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> processor<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消息接收方</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageReceive</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Inventory</span><span class="token punctuation">&gt;</span></span> inventoryMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 模拟数据相关操作
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inventoryMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Inventory</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inventoryMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Inventory</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;plugin-delay-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receivePluginDelayMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Inventory</span> inventory <span class="token operator">=</span> inventoryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前订单信息:{}&quot;</span><span class="token punctuation">,</span> inventory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inventory<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 未支付，回滚库存</span>
                inventory<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>inventory<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token annotation punctuation">@AllArgsConstructor</span>
    <span class="token annotation punctuation">@NoArgsConstructor</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Inventory</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>     <span class="token comment">// 0 代表未支付，1代表已支付</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_5、延迟队列总结" tabindex="-1"><a class="header-anchor" href="#_5、延迟队列总结" aria-hidden="true">#</a> 5、延迟队列总结</h3><ol><li>延迟队列：指消息进入队列后需要一定时间才消费</li><li>RabbitMQ 本身是没有提供延迟队列功能，可以通过 <strong>死信队列 + 过期时间</strong> 来实现延迟队列</li><li>自己实现的延迟队列不能按时消费，可能存在滞后问题，安装延迟队列插件使用</li></ol><h2 id="八、rabbitmq-实战场景" tabindex="-1"><a class="header-anchor" href="#八、rabbitmq-实战场景" aria-hidden="true">#</a> 八、RabbitMQ 实战场景</h2><h3 id="_1、日志与可视化监控查看" tabindex="-1"><a class="header-anchor" href="#_1、日志与可视化监控查看" aria-hidden="true">#</a> 1、日志与可视化监控查看</h3><ul><li><p>日志文件：<code>/var/log/rabbitmq/rabbit@localhost.log</code></p></li><li><p>观察日志操作：</p><ol><li><p>停止服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>/sbin/service rabbitmq-server stop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>重新启动</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl start_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>开启服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl start rabbitmq-server.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol></li></ul><h3 id="_2、消息追踪" tabindex="-1"><a class="header-anchor" href="#_2、消息追踪" aria-hidden="true">#</a> 2、消息追踪</h3><h4 id="_2-1-firehose" tabindex="-1"><a class="header-anchor" href="#_2-1-firehose" aria-hidden="true">#</a> 2.1 Firehose</h4><blockquote><p>生产者给交换机发送消息时，会按照指定格式发送到 amp.rabbitmq.trace（Topic）交换机上</p></blockquote><p>开启 Firehose 命令：<code>rabbitmqctl trace_on</code></p><p>关闭 Firehose 命令：<code>rabbitmqctl trace_off</code></p><p>注意：开启 Firehose 会影响性能，不建议一直打开</p><h4 id="_2-2-rabbitmq-tracing" tabindex="-1"><a class="header-anchor" href="#_2-2-rabbitmq-tracing" aria-hidden="true">#</a> 2.2 rabbitmq_tracing</h4><blockquote><p>开启插件来实现可视化查看</p></blockquote><p>查看插件：<code>rabbitmq-plugins list</code></p><p>启用插件：<code>rabbitmq-plugins enable rabbitmq_tracing</code></p><h3 id="_3、幂等性保证" tabindex="-1"><a class="header-anchor" href="#_3、幂等性保证" aria-hidden="true">#</a> 3、幂等性保证</h3><blockquote><p>**幂等性：**是分布式中比较重要的一个概念，是指在多作业操作时候避免造成重复影响，其实就是保证同一个消息不被消费者重复消费两次。但是实际开发中可能存在网络波动等问题，生产者无法接受消费者发送的ack信息，因此这条消息将会被重复发送给其他消费者进行消费，实际上这条消息已经被消费过了，这就是重复消费的问题。</p></blockquote><p>如何避免重复消费问题？</p><ol><li><p>数据库乐观锁机制</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">update</span> items <span class="token keyword">set</span> count<span class="token operator">=</span>count<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">where</span> count<span class="token operator">=</span> <span class="token comment">#{count} and id = #{id}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">update</span> items <span class="token keyword">set</span> count<span class="token operator">=</span>count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>version<span class="token operator">=</span>version<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">where</span> version<span class="token operator">=</span> <span class="token comment">#{version} and id = #{id}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>生成全局唯一 id + Redis 锁机制</p><p>操作之前先判断是否抢占了分布式锁 setNx 命名</p></li></ol><h2 id="九、rabbitmq-集群" tabindex="-1"><a class="header-anchor" href="#九、rabbitmq-集群" aria-hidden="true">#</a> 九、RabbitMQ 集群</h2><h3 id="_1、目前存在的问题" tabindex="-1"><a class="header-anchor" href="#_1、目前存在的问题" aria-hidden="true">#</a> 1、目前存在的问题</h3><ul><li><p>存在问题：</p><ul><li><p>单节点的RabbitMQ如果内存崩溃、机器掉电或者主板故障，会影响整个业务线正常使用</p></li><li><p>单机吞吐性能会受内存、带宽大小限制</p><figure><img src="/blog/assets/单节点问题-c2d1f791.png" alt="单节点问题" tabindex="0" loading="lazy"><figcaption>单节点问题</figcaption></figure></li></ul></li><li><p>解决方案：使用集群模式来解决</p></li></ul><h3 id="_2、搭建-rabbitmq-集群" tabindex="-1"><a class="header-anchor" href="#_2、搭建-rabbitmq-集群" aria-hidden="true">#</a> 2、搭建 RabbitMQ 集群</h3><figure><img src="/blog/assets/搭建RabbitMQ集群-6d78a14b.png" alt="搭建RabbitMQ集群" tabindex="0" loading="lazy"><figcaption>搭建RabbitMQ集群</figcaption></figure><ol><li><p>停止服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl stop rabbitmq-server.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>分别启动节点</p><p>启动节点1</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">RABBITMQ_NODE_PORT</span><span class="token operator">=</span><span class="token number">5673</span> <span class="token assign-left variable">RABBITMQ_NODENAME</span><span class="token operator">=</span>rabbit-1 rabbitmq-server start
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动节点2</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">RABBITMQ_NODE_PORT</span><span class="token operator">=</span><span class="token number">5674</span> <span class="token assign-left variable">RABBITMQ_SERVER_START_ARGS</span><span class="token operator">=</span><span class="token string">&quot;-rabbitmq_management listener [{port,15674}]&quot;</span> <span class="token assign-left variable">RABBITMQ_NODENAME</span><span class="token operator">=</span>rabbit-2 rabbitmq-server start
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>开放端口</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">15673</span>/tcp <span class="token parameter variable">--permanent</span>
firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">15674</span>/tcp <span class="token parameter variable">--permanent</span>
firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>设置主从节点</p><ul><li><p>设置节点1为主节点</p><p>停止节点1</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-1 stop_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重置节点1</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-1 reset
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动节点1</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-1 start_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>设置节点2为从节点</p><p>停止节点2</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 stop_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重置节点2</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 reset
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>设置从节点2</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 join_cluster rabbit-1@<span class="token string">&#39;localhost&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动节点2</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 start_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>查看集群状态</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl cluster_status <span class="token parameter variable">-n</span> rabbit-1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul></li><li><p>添加用户</p><ul><li><p>添加节点1用户</p><p>添加用户</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-1 add_user taiyi1 <span class="token number">123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>添加角色</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-1 set_user_tags taiyi1 administrator
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>添加权限</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-1 set_permissions <span class="token parameter variable">-p</span> <span class="token string">&quot;/&quot;</span> taiyi1 <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>添加节点2用户</p><p>添加用户</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 add_user taiyi2 <span class="token number">123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>添加角色</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 set_user_tags taiyi2 administrator
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>添加权限</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl <span class="token parameter variable">-n</span> rabbit-2 set_permissions <span class="token parameter variable">-p</span> <span class="token string">&quot;/&quot;</span> taiyi2 <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul></li><li><p>集群数据同步配置</p><figure><img src="/blog/assets/集群数据同步配置-83fcefb6.png" alt="集群数据同步配置" tabindex="0" loading="lazy"><figcaption>集群数据同步配置</figcaption></figure></li></ol><h3 id="_3、rabbitmq-集群存在的问题" tabindex="-1"><a class="header-anchor" href="#_3、rabbitmq-集群存在的问题" aria-hidden="true">#</a> 3、RabbitMQ 集群存在的问题</h3><figure><img src="/blog/assets/RabbitMQ集群存在的问题-d71a1383.png" alt="RabbitMQ集群存在的问题" tabindex="0" loading="lazy"><figcaption>RabbitMQ集群存在的问题</figcaption></figure><p>HAProxy 安装和使用</p><blockquote><p><strong>HAProxy</strong>是一个使用C语言编写的<a href="./https://baike.baidu.com/item/%E8%87%AA%E7%94%B1%E5%8F%8A%E5%BC%80%E6%94%BE%E6%BA%90%E4%BB%A3%E7%A0%81%E8%BD%AF%E4%BB%B6?fromModule=lemma_inlink">自由及开放源代码软件</a>，其提供<a href="./https://baike.baidu.com/item/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7/909038?fromModule=lemma_inlink">高可用性</a>、<a href="./https://baike.baidu.com/item/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/932451?fromModule=lemma_inlink">负载均衡</a>，以及基于<a href="./https://baike.baidu.com/item/TCP?fromModule=lemma_inlink">TCP</a>和<a href="./https://baike.baidu.com/item/HTTP?fromModule=lemma_inlink">HTTP</a>的应用程序<a href="./https://baike.baidu.com/item/%E4%BB%A3%E7%90%86/3242667?fromModule=lemma_inlink">代理</a>。</p><p>下载地址：https://www.haproxy.org/download/</p></blockquote><ul><li><p>安装</p><p>解压</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> haproxy-2.3.21.tar.gz <span class="token parameter variable">-C</span> /usr/local
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>编译安装</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /usr/local/haproxy-2.3.21
<span class="token function">make</span> <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux31 <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>赋权</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">groupadd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-g</span> <span class="token number">149</span> haproxy
<span class="token function">useradd</span> <span class="token parameter variable">-g</span> haproxy <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin <span class="token parameter variable">-u</span> <span class="token number">149</span> haproxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>添加配置文件</p><p>创建haproxy配置文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> /etc/haproxy
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>haproxy.cfg</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#logging options</span>
global
	log <span class="token number">127.0</span>.0.1 local0 info
	maxconn <span class="token number">5120</span>
	<span class="token function">chroot</span> /usr/local/haproxy
	uid <span class="token number">99</span>
	gid <span class="token number">99</span>
	daemon
	quiet
	nbproc <span class="token number">20</span>
	pidfile /var/run/haproxy.pid

defaults
	log global
	
	mode tcp

	option dontlognull
	retries <span class="token number">3</span>
	option redispatch
	maxconn <span class="token number">2000</span>
	<span class="token function">timeout</span> connect 5s
   
    <span class="token function">timeout</span> client 60s

    <span class="token function">timeout</span> server 15s	
<span class="token comment">#front-end IP for consumers and producters</span>

listen rabbitmq_cluster
	<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:5672
	
	mode tcp
	<span class="token comment">#balance url_param userid</span>
	<span class="token comment">#balance url_param session_id check_post 64</span>
	<span class="token comment">#balance hdr(User-Agent)</span>
	<span class="token comment">#balance hdr(host)</span>
	<span class="token comment">#balance hdr(Host) use_domain_only</span>
	<span class="token comment">#balance rdp-cookie</span>
	<span class="token comment">#balance leastconn</span>
	<span class="token comment">#balance source //ip</span>
	
	balance roundrobin
	
        server node1 <span class="token number">127.0</span>.0.1:5673 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>
        server node2 <span class="token number">127.0</span>.0.1:5674 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>

listen stats
	<span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.81.128:8100
	mode http
	option httplog
	stats <span class="token builtin class-name">enable</span>
	stats uri /rabbitmq-stats
	stats refresh 5s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>启动 haproxy</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>/usr/local/haproxy/sbin/haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>查看监控页面</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>http://192.168.81.128:8100/rabbitmq-stats
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h3 id="_4、rabbitmq-集群解决" tabindex="-1"><a class="header-anchor" href="#_4、rabbitmq-集群解决" aria-hidden="true">#</a> 4、RabbitMQ 集群解决</h3><figure><img src="/blog/assets/RabbitMQ集群解决-0f54f05c.png" alt="RabbitMQ集群解决" tabindex="0" loading="lazy"><figcaption>RabbitMQ集群解决</figcaption></figure></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><!----><!----></div></footer><nav class="page-nav"><a href="/blog/%E7%AC%94%E8%AE%B0/Nginx.html" class="nav-link prev" aria-label="Nginx"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Nginx</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-de24951d.js" defer></script>
  </body>
</html>
